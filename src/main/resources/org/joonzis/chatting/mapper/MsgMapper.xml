<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.joonzis.chatting.mapper.MsgMapper">

	<resultMap id="MsgResultMap"
		type="org.joonzis.chatting.vo.MsgVO">
		<id property="msg_id" column="msg_id" />
		<result property="room_id" column="room_id" />
		<result property="sender_id" column="sender_id" />
		<result property="content" column="content" />
		<result property="created_at" column="created_at"
			javaType="java.util.Date" />
		<result property="msg_type" column="msg_type" />
		<result property="file_path" column="file_path" />
		<result property="original_name" column="original_name" />
		<result property="saved_name" column="saved_name" />
		<result property="file_size" column="file_size" />
		<result property="is_active" column="is_active" />
	</resultMap>

	<!-- 1. 메시지 삽입 -->
	<insert id="insert"
		parameterType="org.joonzis.chatting.vo.MsgVO" keyProperty="msg_id">
		INSERT INTO tbl_msg (
			msg_id,
			room_id,
			sender_id,
			content,
			msg_type,
			file_path,
			original_name,
			saved_name,
			file_size,
			is_active,
			created_at
		)
		VALUES (
			msg_seq.NEXTVAL,
			#{room_id},
			#{sender_id},
			#{content},
			#{msg_type},
			#{file_path},
			#{original_name},
			#{saved_name},
			#{file_size},
			#{is_active},
			SYSTIMESTAMP
		)
		<selectKey keyProperty="msg_id" resultType="long"
			order="AFTER">
			SELECT msg_seq.CURRVAL FROM dual
		</selectKey>
	</insert>

	<!-- 2. 채팅방의 모든 메시지 조회 -->
	<select id="findByRoomId" parameterType="int"
		resultMap="MsgResultMap">
		SELECT *
		FROM tbl_msg
		WHERE room_id = #{room_id}
		ORDER BY
		msg_id ASC
	</select>

	<!-- 3. 마지막 읽은 메시지 이후 메시지 조회 -->
	<select id="findAfterMsgId" resultMap="MsgResultMap">
		SELECT *
		FROM tbl_msg
		WHERE room_id = #{room_id}
		AND <![CDATA[msg_id > #{msg_id}]]>
		ORDER BY msg_id ASC
	</select>

	<!-- 4. 마지막 메세지 조회(가장 최근 메세지) -->
	<select id="findLastMsgIdByRoom" resultType="long">
		SELECT MAX(msg_id)
		FROM tbl_msg
		WHERE room_id = #{room_id}
	</select>

	<!-- 5. 아이디로 메세지 조회 -->
	<select id="findById" resultMap="MsgResultMap">
		SELECT *
		FROM tbl_msg
		WHERE msg_id
		= #{msg_id}
	</select>

	<!-- 6. 메세지 내용으로 메세지 아이디 조회 -->
	<select id="searchByMessage" parameterType="map"
		resultType="org.joonzis.chatting.dto.RoomSearchResultDTO">
		SELECT
		m.room_id,
		m.msg_id AS search_msg_id,
		u.nickname AS
		otherUserName,
		u.user_id AS otherUserId
		FROM tbl_msg m
		JOIN
		tbl_chat_room_user cru ON
		cru.room_id = m.room_id
		JOIN tbl_user u ON
		u.user_id = cru.user_id AND
		u.user_id != #{user_id}
		WHERE m.content LIKE
		'%' || #{keyword}|| '%'
		ORDER BY m.msg_id DESC
	</select>



</mapper>
