<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.joonzis.community.mapper.CommunityMainMapper">

  <resultMap id="CommunityPostCardMap" type="org.joonzis.community.dto.CommunityPostCardDTO">
    <result property="boardId"    column="BOARD_ID"/>
    <result property="title"      column="TITLE"/>
    <result property="author"     column="AUTHOR"/>
    <result property="thumbSrc"   column="THUMB_SRC"/>
    <result property="viewCount"  column="VIEW_COUNT"/>
    <result property="likeCount"  column="LIKE_COUNT"/>
    <result property="replyCount" column="REPLY_CNT"/>
    <result property="hashtags"   column="HASHTAGS"/>
  </resultMap>

  <!--
    공통 베이스:
    - TBL_BOARD: 게시글
    - TBL_USER: 작성자 닉네임/이름
    - TBL_BOARD_FILE: 썸네일(있는 경우 1장)
    - TBL_BOARD_ASPECT + TBL_BOARD_HASHTAG_LIST: 해시태그 문자열로 합치기
  -->
  <sql id="BaseSelect">
    SELECT
      B.BOARD_ID,
      B.TITLE,
      NVL(U.NICKNAME, '익명') AS AUTHOR,
      NVL(B.VIEW_COUNT, 0) AS VIEW_COUNT,
      NVL(B.LIKE_COUNT, 0) AS LIKE_COUNT,
      NVL(B.REPLY_CNT, 0) AS REPLY_CNT,

      /* 썸네일 1장 */
      (
        SELECT F.SAVED_NAME
        FROM TBL_BOARD_FILE F
        WHERE F.BOARD_ID = B.BOARD_ID
          AND F.IS_THUMBNAIL = 'Y'
        FETCH FIRST 1 ROWS ONLY
      ) AS THUMB_SRC,

      /* 해시태그 LISTAGG (없으면 NULL) */
      (
        SELECT LISTAGG(H.BOARD_HASHTAG_NAME, ',') WITHIN GROUP (ORDER BY H.BOARD_HASHTAG_NAME)
        FROM TBL_BOARD_ASPECT A
        JOIN TBL_BOARD_HASHTAG_LIST H
          ON H.BOARD_HASHTAG_ID = A.BOARD_HASHTAG_LIST
        WHERE A.BOARD_ID = B.BOARD_ID
          AND H.IS_ACTIVE = 'Y'
      ) AS HASHTAGS

    FROM TBL_BOARD B
    JOIN TBL_USER U
      ON U.USER_ID = B.USER_ID
    WHERE B.IS_ACTIVE = 'Y'
  </sql>

  <select id="selectPopularPosts" parameterType="int" resultMap="CommunityPostCardMap">
    <include refid="BaseSelect"/>
    ORDER BY NVL(B.LIKE_COUNT, 0) DESC, B.REG_DATE DESC
    FETCH FIRST #{limit} ROWS ONLY
  </select>

  <select id="selectHotPosts" parameterType="int" resultMap="CommunityPostCardMap">
    <include refid="BaseSelect"/>
    ORDER BY NVL(B.VIEW_COUNT, 0) DESC, B.REG_DATE DESC
    FETCH FIRST #{limit} ROWS ONLY
  </select>

  <select id="selectLatestPosts" parameterType="int" resultMap="CommunityPostCardMap">
    <include refid="BaseSelect"/>
    ORDER BY B.REG_DATE DESC
    FETCH FIRST #{limit} ROWS ONLY
  </select>

  <!-- 전체보기: kind에 따라 정렬 + (원하면 board_type 제한도 가능) -->
  <select id="selectMorePosts" parameterType="map" resultMap="CommunityPostCardMap">
    <include refid="BaseSelect"/>

    <if test="boardType != null and boardType != ''">
      AND B.BOARD_TYPE = #{boardType}
    </if>

    <choose>
      <when test="kind == 'popular'">
        ORDER BY NVL(B.LIKE_COUNT, 0) DESC, B.REG_DATE DESC
      </when>
      <when test="kind == 'hot'">
        ORDER BY NVL(B.VIEW_COUNT, 0) DESC, B.REG_DATE DESC
      </when>
      <otherwise>
        ORDER BY B.REG_DATE DESC
      </otherwise>
    </choose>

    FETCH FIRST #{limit} ROWS ONLY
  </select>

</mapper>